<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bond Convexity Explorer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      body { background: #f8fafc; color: #0f172a; }
      .card { background: #ffffff; border: 1px solid #e2e8f0; }
      .form-control, .form-select { background: #ffffff; color: #0f172a; border-color: #cbd5e1; }
      .form-control:focus, .form-select:focus { box-shadow: 0 0 0 0.1rem rgba(14, 165, 233, 0.2); }
      .navbar { background: #ffffff; border-bottom: 1px solid #e2e8f0; }
      .navbar .navbar-brand { color: #0f172a; }
      .text-muted { color: #475569 !important; }
      .badge { background: #0ea5e9; }
      canvas { background: #ffffff; border-radius: 12px; border: 1px solid #e2e8f0; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg mb-4 shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="#">Bond Convexity Explorer</a>
        <span class="text-muted small">Interactive yield/price sandbox</span>
      </div>
    </nav>

    <div class="container pb-5">
      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title mb-3">Choose a saved bond</h5>
              <p class="text-muted small">Use one of the JSON-defined bonds or fill in the form manually.</p>
              <select id="bond-picker" class="form-select mb-3"></select>
              <button class="btn btn-primary w-100" id="load-bond">Load bond into form</button>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title mb-3">Bond inputs</h5>
              <form id="bond-form" class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Par value</label>
                  <input type="number" step="0.01" class="form-control" name="par_value" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Coupon rate (%)</label>
                  <input type="number" step="0.01" class="form-control" name="coupon_rate" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Coupon frequency (per year)</label>
                  <input type="number" class="form-control" name="coupon_frequency" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Purchase price</label>
                  <input type="number" step="0.01" class="form-control" name="price" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Issue date (DD/MM/YYYY)</label>
                  <input type="text" class="form-control" name="issue_date" placeholder="15/03/2020" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Purchase date</label>
                  <input type="text" class="form-control" name="purchase_date" placeholder="15/03/2025" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Maturity date</label>
                  <input type="text" class="form-control" name="maturity_date" placeholder="15/03/2030" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Min price (curve)</label>
                  <input type="number" step="0.01" class="form-control" name="min_price" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Max price (curve)</label>
                  <input type="number" step="0.01" class="form-control" name="max_price" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Number of curve points</label>
                  <input type="number" class="form-control" name="num_points" value="50" required>
                </div>
                <div class="col-12">
                  <button class="btn btn-success" type="submit">Run analysis</button>
                </div>
              </form>
              <div id="alert-container" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-1">
        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title mb-3">Bond snapshot</h5>
              <dl class="row" id="summary"></dl>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Price vs. yield</h6>
                <span class="badge">Curve</span>
              </div>
              <canvas id="curve-chart" height="180"></canvas>
            </div>
          </div>
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Yield sensitivity</h6>
                <span class="badge">First derivative</span>
              </div>
              <canvas id="derivative-chart" height="180"></canvas>
            </div>
          </div>
          <div class="card shadow-sm mt-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Price change vs. yield</h6>
                <span class="badge">Relative delta</span>
              </div>
              <canvas id="price-change-chart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const bonds = {{ bonds | tojson }};
      const picker = document.getElementById('bond-picker');
      const form = document.getElementById('bond-form');
      const summary = document.getElementById('summary');
      const alertContainer = document.getElementById('alert-container');
      const barLabelPlugin = {
        id: 'barLabel',
        afterDatasetsDraw(chart, args, opts) {
          // Only render labels for bar charts to avoid showing objects on line plots
          if (chart.config.type !== 'bar') return;

          const { ctx } = chart;
          ctx.save();
          const formatter = opts.formatter || ((value) => value);
          chart.data.datasets.forEach((dataset, datasetIndex) => {
            const meta = chart.getDatasetMeta(datasetIndex);
            meta.data.forEach((element, idx) => {
              const value = dataset.data[idx];
              const label = formatter(value, idx, dataset);
              ctx.fillStyle = '#0f172a';
              ctx.font = '11px sans-serif';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'bottom';
              ctx.fillText(label, element.x, element.y - 4);
            });
          });
          ctx.restore();
        },
      };
      Chart.register(barLabelPlugin);

      function populatePicker() {
        picker.innerHTML = '';
        Object.keys(bonds).forEach((name, idx) => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          if (idx === 0) option.selected = true;
          picker.appendChild(option);
        });
      }

      function fillForm(bond) {
        if (!bond) return;
        Object.entries(bond).forEach(([key, value]) => {
          const input = form.elements.namedItem(key);
          if (input) input.value = value;
        });
      }

      function showAlert(message, type = 'danger') {
        alertContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      }

      function renderSummary(data) {
        const items = [
          ['Par value', data.par_value],
          ['Coupon rate', `${data.coupon_rate}%`],
          ['Frequency', `${data.coupon_frequency}x/year`],
          ['Issue date', data.issue_date],
          ['Purchase date', data.purchase_date],
          ['Maturity', data.maturity_date],
          ['Purchase price', data.price],
          ['Accrued interest', data.accrued_interest?.toFixed ? data.accrued_interest.toFixed(2) : data.accrued_interest],
          ['Yield to maturity', data.ytm?.toFixed ? `${data.ytm.toFixed(3)}%` : data.ytm],
          ['Curve span', `${data.min_price}–${data.max_price}`],
          ['Curve points', data.num_points],
          ['Periods', data.periods],
        ];
        summary.innerHTML = items.map(([label, value]) => `
          <dt class="col-6 text-muted">${label}</dt>
          <dd class="col-6">${value ?? '—'}</dd>
        `).join('');
      }

      let curveChart, derivativeChart, priceChangeChart;
      function toPoints(xs, ys) {
        const points = [];
        xs.forEach((x, idx) => {
          const xv = Number(x);
          const yv = Number(ys[idx]);
          if (Number.isFinite(xv) && Number.isFinite(yv)) {
            points.push({ x: xv, y: yv });
          }
        });
        return points;
      }

      function renderCharts(curve, derivative) {
        const ctx = document.getElementById('curve-chart');
        const dctx = document.getElementById('derivative-chart');
        const curvePoints = toPoints(curve.ytm, curve.price);
        const derivativePoints = toPoints(derivative.ytm, derivative.price_derivative);
        const curveData = {
          datasets: [{
            label: 'Price',
            data: curvePoints,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,0.15)',
            tension: 0.3,
            fill: true,
          }]
        };
        const derivativeData = {
          datasets: [{
            label: 'dPrice/dYTM',
            data: derivativePoints,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245,158,11,0.15)',
            tension: 0.2,
            fill: true,
          }]
        };
        const options = {
          responsive: true,
          parsing: false,
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'Yield to Maturity (%)', color: '#0f172a' },
              ticks: { color: '#0f172a', callback: (value) => Number(value).toFixed(2) },
              grid: { color: '#e2e8f0' },
            },
            y: { ticks: { color: '#0f172a' }, grid: { color: '#e2e8f0' } }
          },
          plugins: { legend: { labels: { color: '#0f172a' } } }
        };
        if (curveChart) curveChart.destroy();
        if (derivativeChart) derivativeChart.destroy();
        curveChart = new Chart(ctx, { type: 'line', data: curveData, options });
        derivativeChart = new Chart(dctx, { type: 'line', data: derivativeData, options });
      }

      function renderPriceChange(changeData) {
        const bctx = document.getElementById('price-change-chart');
        const labels = (changeData?.ytm || []).map((ytm) => `${Number(ytm).toFixed(0)}%`);
        const deltas = changeData?.price_change_pct || [];

        const dataset = {
          label: 'Price change vs. current yield',
          data: deltas,
          backgroundColor: (context) => {
            const value = Number(context.raw);
            return Number.isFinite(value) && value >= 0 ? 'rgba(34,197,94,0.65)' : 'rgba(239,68,68,0.65)';
          },
          borderColor: (context) => {
            const value = Number(context.raw);
            return Number.isFinite(value) && value >= 0 ? '#16a34a' : '#dc2626';
          },
          borderWidth: 1,
        };

        const options = {
          responsive: true,
          scales: {
            x: {
              title: { display: true, text: 'Yield to Maturity (%)', color: '#0f172a' },
              ticks: { color: '#0f172a' },
              grid: { color: '#e2e8f0' },
            },
            y: {
              title: { display: true, text: 'Price change (%)', color: '#0f172a' },
              ticks: { color: '#0f172a', callback: (value) => `${value.toFixed(1)}%` },
              grid: { color: '#e2e8f0' },
            },
          },
          plugins: {
            legend: { labels: { color: '#0f172a' } },
            barLabel: {
              formatter: (value) => {
                if (!Number.isFinite(value)) return '—';
                return `${value.toFixed(2)}%`;
              },
            },
          },
        };

        if (priceChangeChart) priceChangeChart.destroy();
        priceChangeChart = new Chart(bctx, { type: 'bar', data: { labels, datasets: [dataset] }, options });
      }

      document.getElementById('load-bond').addEventListener('click', () => {
        const bond = bonds[picker.value];
        fillForm(bond);
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = Object.fromEntries(new FormData(form).entries());
        try {
          const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
          });
          const payload = await response.json();
          if (!response.ok) {
            showAlert(payload.error || 'Unable to compute analysis');
            return;
          }
          alertContainer.innerHTML = '';
          renderSummary(payload.summary);
          renderCharts(payload.curve, payload.derivative);
          renderPriceChange(payload.price_change);
        } catch (err) {
          showAlert('Something went wrong while reaching the API.');
        }
      });

      populatePicker();
      fillForm(bonds[picker.value]);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
